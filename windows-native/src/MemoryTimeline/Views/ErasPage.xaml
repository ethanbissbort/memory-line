<Page
    x:Class="MemoryTimeline.Views.ErasPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:MemoryTimeline.Data.Models"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
    Loaded="Page_Loaded">

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0">
                <TextBlock Text="Eras &amp; Life Phases" Style="{StaticResource TitleTextBlockStyle}"/>
                <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                          Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                          Margin="0,4,0,0"/>
            </StackPanel>

            <Button Grid.Column="1" Style="{StaticResource AccentButtonStyle}"
                   Click="AddEra_Click">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE710;" FontSize="14"/>
                    <TextBlock Text="Add Era"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="360"/>
            </Grid.ColumnDefinitions>

            <!-- Eras List -->
            <Grid Grid.Column="0" Padding="0,0,16,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- List Header -->
                <Grid Grid.Row="0" Margin="0,0,0,8">
                    <TextBlock Text="{x:Bind ViewModel.TotalEraCount, Mode=OneWay}"
                              Style="{StaticResource BodyStrongTextBlockStyle}">
                        <TextBlock.Inlines>
                            <Run Text="{x:Bind ViewModel.TotalEraCount, Mode=OneWay}"/>
                            <Run Text=" eras defined"/>
                        </TextBlock.Inlines>
                    </TextBlock>
                </Grid>

                <!-- Eras ListView -->
                <ListView Grid.Row="1"
                         ItemsSource="{x:Bind ViewModel.Eras, Mode=OneWay}"
                         SelectedItem="{x:Bind ViewModel.SelectedEra, Mode=TwoWay}"
                         SelectionMode="Single"
                         IsItemClickEnabled="True"
                         ItemClick="Era_ItemClick">
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="models:Era">
                            <Grid Padding="16" Margin="0,4"
                                 Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                 CornerRadius="8">
                                <Grid.ContextFlyout>
                                    <MenuFlyout>
                                        <MenuFlyoutItem Text="Edit Era" Click="EditEra_Click">
                                            <MenuFlyoutItem.Icon>
                                                <FontIcon Glyph="&#xE70F;"/>
                                            </MenuFlyoutItem.Icon>
                                        </MenuFlyoutItem>
                                        <MenuFlyoutSeparator/>
                                        <MenuFlyoutItem Text="Delete Era" Click="DeleteEra_Click">
                                            <MenuFlyoutItem.Icon>
                                                <FontIcon Glyph="&#xE74D;"/>
                                            </MenuFlyoutItem.Icon>
                                        </MenuFlyoutItem>
                                    </MenuFlyout>
                                </Grid.ContextFlyout>

                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="8"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Color indicator bar -->
                                <Rectangle Grid.Column="0"
                                          Fill="{x:Bind ColorCode}"
                                          RadiusX="4" RadiusY="4"
                                          Width="8" Margin="0,0,12,0"/>

                                <!-- Era details -->
                                <StackPanel Grid.Column="1" Spacing="4">
                                    <TextBlock Text="{x:Bind Name}"
                                              Style="{StaticResource SubtitleTextBlockStyle}"/>
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon Glyph="&#xE787;" FontSize="12"
                                                 Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        <TextBlock FontSize="13"
                                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                            <Run Text="{x:Bind StartDate, Converter={StaticResource DateFormatConverter}}"/>
                                            <Run Text=" - "/>
                                            <Run Text="{x:Bind EndDate, Converter={StaticResource DateFormatConverter}, TargetNullValue='Present'}"/>
                                        </TextBlock>
                                    </StackPanel>
                                    <TextBlock Text="{x:Bind Description}"
                                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                              FontSize="13"
                                              TextTrimming="CharacterEllipsis"
                                              MaxLines="1"
                                              Visibility="{x:Bind Description, Converter={StaticResource NullToVisibilityConverter}}"/>
                                </StackPanel>

                                <!-- Duration badge -->
                                <Border Grid.Column="2"
                                       Background="{ThemeResource LayerFillColorDefaultBrush}"
                                       CornerRadius="4" Padding="8,4"
                                       VerticalAlignment="Center">
                                    <TextBlock x:Name="DurationText"
                                              FontSize="12"
                                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <!-- Loading indicator -->
                <ProgressRing Grid.Row="1"
                             IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                             Width="48" Height="48"
                             HorizontalAlignment="Center"
                             VerticalAlignment="Center"/>

                <!-- Empty state -->
                <StackPanel Grid.Row="1"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Spacing="16"
                           Visibility="{x:Bind ViewModel.TotalEraCount, Mode=OneWay, Converter={StaticResource ZeroToVisibilityConverter}}">
                    <FontIcon Glyph="&#xE81C;" FontSize="48"
                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    <TextBlock Text="No eras defined yet"
                              Style="{StaticResource SubtitleTextBlockStyle}"
                              HorizontalAlignment="Center"/>
                    <TextBlock Text="Create eras to organize your life phases like high school, college, jobs, relationships, etc."
                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                              TextWrapping="Wrap"
                              TextAlignment="Center"
                              MaxWidth="300"/>
                    <Button Content="Create Your First Era"
                           Style="{StaticResource AccentButtonStyle}"
                           Click="AddEra_Click"/>
                </StackPanel>
            </Grid>

            <!-- Details Panel -->
            <Border Grid.Column="1"
                   Background="{ThemeResource LayerFillColorDefaultBrush}"
                   CornerRadius="8"
                   Padding="20">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Spacing="16">
                        <!-- Panel Header -->
                        <TextBlock Text="{x:Bind ViewModel.SelectedEra.Name, Mode=OneWay, FallbackValue='Era Details'}"
                                  Style="{StaticResource SubtitleTextBlockStyle}"/>

                        <!-- No selection state -->
                        <StackPanel Spacing="12"
                                   Visibility="{x:Bind ViewModel.SelectedEra, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Invert}">
                            <FontIcon Glyph="&#xE8A5;" FontSize="32"
                                     Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                     HorizontalAlignment="Center"/>
                            <TextBlock Text="Select an era to view details"
                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                      HorizontalAlignment="Center"/>
                        </StackPanel>

                        <!-- Selected era details -->
                        <StackPanel Spacing="16"
                                   Visibility="{x:Bind ViewModel.SelectedEra, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">

                            <!-- Color preview -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Rectangle Grid.Column="0"
                                          Fill="{x:Bind ViewModel.SelectedEra.ColorCode, Mode=OneWay}"
                                          Width="24" Height="24"
                                          RadiusX="4" RadiusY="4"
                                          Margin="0,0,12,0"/>
                                <TextBlock Grid.Column="1"
                                          Text="{x:Bind ViewModel.SelectedEra.ColorCode, Mode=OneWay}"
                                          VerticalAlignment="Center"
                                          Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                            </Grid>

                            <!-- Date range -->
                            <StackPanel Spacing="4">
                                <TextBlock Text="Time Period" FontWeight="SemiBold"/>
                                <TextBlock Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                    <Run Text="{x:Bind ViewModel.SelectedEra.StartDate, Mode=OneWay, Converter={StaticResource DateFormatConverter}}"/>
                                    <Run Text=" to "/>
                                    <Run Text="{x:Bind ViewModel.SelectedEra.EndDate, Mode=OneWay, Converter={StaticResource DateFormatConverter}, TargetNullValue='Present'}"/>
                                </TextBlock>
                            </StackPanel>

                            <!-- Description -->
                            <StackPanel Spacing="4"
                                       Visibility="{x:Bind ViewModel.SelectedEra.Description, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                                <TextBlock Text="Description" FontWeight="SemiBold"/>
                                <TextBlock Text="{x:Bind ViewModel.SelectedEra.Description, Mode=OneWay}"
                                          TextWrapping="Wrap"
                                          Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                            </StackPanel>

                            <!-- Actions -->
                            <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                                <Button Content="Edit" Click="EditSelectedEra_Click"
                                       Style="{StaticResource AccentButtonStyle}"/>
                                <Button Content="Delete" Click="DeleteSelectedEra_Click"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Add/Edit Era Dialog -->
        <ContentDialog x:Name="EraDialog"
                      Title="Add Era"
                      PrimaryButtonText="Save"
                      CloseButtonText="Cancel"
                      DefaultButton="Primary"
                      PrimaryButtonClick="EraDialog_PrimaryButtonClick">
            <StackPanel Spacing="16" MinWidth="400">
                <TextBox x:Name="EraNameBox"
                        Header="Name"
                        PlaceholderText="e.g., High School, College, First Job"/>

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <CalendarDatePicker x:Name="EraStartDatePicker"
                                       Grid.Column="0"
                                       Header="Start Date"
                                       PlaceholderText="Select start"
                                       DateFormat="{}{month.abbreviated} {day.integer}, {year.full}"
                                       HorizontalAlignment="Stretch"
                                       Margin="0,0,8,0"/>

                    <CalendarDatePicker x:Name="EraEndDatePicker"
                                       Grid.Column="1"
                                       Header="End Date (optional)"
                                       PlaceholderText="Ongoing"
                                       DateFormat="{}{month.abbreviated} {day.integer}, {year.full}"
                                       HorizontalAlignment="Stretch"
                                       Margin="8,0,0,0"/>
                </Grid>

                <!-- Color picker -->
                <StackPanel Spacing="8">
                    <TextBlock Text="Color" FontWeight="SemiBold"/>
                    <GridView x:Name="ColorPaletteGrid"
                             SelectionMode="Single"
                             SelectionChanged="ColorPalette_SelectionChanged"
                             ItemsSource="{x:Bind ColorPalette}">
                        <GridView.ItemTemplate>
                            <DataTemplate x:DataType="x:String">
                                <Rectangle Fill="{x:Bind}"
                                          Width="32" Height="32"
                                          RadiusX="4" RadiusY="4"
                                          Margin="2"/>
                            </DataTemplate>
                        </GridView.ItemTemplate>
                        <GridView.ItemsPanel>
                            <ItemsPanelTemplate>
                                <ItemsWrapGrid Orientation="Horizontal" MaximumRowsOrColumns="8"/>
                            </ItemsPanelTemplate>
                        </GridView.ItemsPanel>
                    </GridView>

                    <!-- Custom color input -->
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBox x:Name="CustomColorBox"
                                PlaceholderText="#RRGGBB"
                                Width="100"
                                TextChanged="CustomColorBox_TextChanged"/>
                        <Rectangle x:Name="ColorPreview"
                                  Width="32" Height="32"
                                  RadiusX="4" RadiusY="4"/>
                    </StackPanel>
                </StackPanel>

                <TextBox x:Name="EraDescriptionBox"
                        Header="Description (optional)"
                        PlaceholderText="Brief description of this life phase"
                        AcceptsReturn="True"
                        TextWrapping="Wrap"
                        Height="80"/>
            </StackPanel>
        </ContentDialog>

        <!-- Delete Confirmation Dialog -->
        <ContentDialog x:Name="DeleteConfirmDialog"
                      Title="Delete Era"
                      Content="Are you sure you want to delete this era? Events associated with this era will not be deleted but will no longer have an era assigned."
                      PrimaryButtonText="Delete"
                      CloseButtonText="Cancel"
                      DefaultButton="Close"
                      PrimaryButtonClick="DeleteConfirmDialog_PrimaryButtonClick"/>
    </Grid>
</Page>
