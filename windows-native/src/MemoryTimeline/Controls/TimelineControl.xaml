<UserControl
    x:Class="MemoryTimeline.Controls.TimelineControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:MemoryTimeline.Controls"
    xmlns:dto="using:MemoryTimeline.Core.DTOs"
    mc:Ignorable="d"
    d:DesignHeight="600"
    d:DesignWidth="1000">

    <Grid x:Name="RootGrid" Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <Grid.RowDefinitions>
            <!-- Era filter panel (collapsible) -->
            <RowDefinition Height="Auto"/>
            <!-- Main timeline area with era bars and events -->
            <RowDefinition Height="*"/>
            <!-- Proportional scrollbar -->
            <RowDefinition Height="Auto"/>
            <!-- Bottom command bar -->
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Loading overlay -->
        <Grid x:Name="LoadingOverlay"
              Grid.RowSpan="4"
              Visibility="Collapsed"
              Background="#80000000"
              Canvas.ZIndex="1000">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="12">
                <ProgressRing IsActive="True" Width="48" Height="48"/>
                <TextBlock Text="Loading timeline..."
                          FontSize="16"
                          Foreground="White"
                          HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>

        <!-- Era filter panel -->
        <Border Grid.Row="0"
                Background="{ThemeResource LayerFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="0,0,0,1"
                Padding="12,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Text="Era Filters:"
                          VerticalAlignment="Center"
                          FontWeight="SemiBold"
                          Margin="0,0,12,0"/>

                <!-- Era filter checkboxes (populated dynamically) -->
                <ItemsControl x:Name="EraFiltersPanel"
                             Grid.Column="1"
                             ItemsSource="{x:Bind ViewModel.EraFilters, Mode=OneWay}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="16"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="dto:EraFilterDto">
                            <CheckBox Content="{x:Bind Name}"
                                     IsChecked="{x:Bind IsVisible, Mode=TwoWay}"
                                     Foreground="{x:Bind ColorBrush, Mode=OneWay}"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                    <Button Content="All"
                           Click="ShowAllEras_Click"
                           Padding="8,4"/>
                    <Button Content="None"
                           Click="HideAllEras_Click"
                           Padding="8,4"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main timeline area - NO ScrollViewer, just a clipped container -->
        <Grid x:Name="TimelineContainer"
              Grid.Row="1"
              Background="Transparent">

            <!-- Timeline canvas fills the container, content positioned relative to viewport -->
            <Grid x:Name="TimelineCanvas"
                  Background="Transparent"
                  ManipulationMode="TranslateX,TranslateInertia"
                  ManipulationDelta="TimelineCanvas_ManipulationDelta"
                  ManipulationCompleted="TimelineCanvas_ManipulationCompleted"
                  DoubleTapped="TimelineCanvas_DoubleTapped"
                  RightTapped="TimelineCanvas_RightTapped"
                  PointerMoved="TimelineCanvas_PointerMoved">

                <Grid.RowDefinitions>
                    <!-- Events area (map pins stack upward from era bars) -->
                    <RowDefinition Height="*" MinHeight="200"/>
                    <!-- Era bars area (thin horizontal colored lines) -->
                    <RowDefinition Height="Auto"/>
                    <!-- Timeline axis and ticks (bottom quarter) -->
                    <RowDefinition Height="80"/>
                </Grid.RowDefinitions>

                <!-- Context menu for timeline canvas (add event) -->
                <Grid.ContextFlyout>
                    <MenuFlyout x:Name="TimelineContextMenu">
                        <MenuFlyoutItem x:Name="AddEventMenuItem"
                                       Text="Add Event Here"
                                       Click="AddEventMenuItem_Click">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE710;"/>
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutSeparator/>
                        <MenuFlyoutItem Text="Go to Date..."
                                       Click="GoToDateMenuItem_Click">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE8DA;"/>
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutItem Text="Go to Today"
                                       Command="{x:Bind ViewModel.GoToTodayCommand}">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE8D1;"/>
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutItem Text="Refresh"
                                       Command="{x:Bind ViewModel.RefreshCommand}">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE72C;"/>
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                    </MenuFlyout>
                </Grid.ContextFlyout>

                <!-- Events layer - map pins in the upper area, stacking upward -->
                <Canvas x:Name="EventsCanvas" Grid.Row="0" Grid.RowSpan="2">
                    <ItemsControl x:Name="EventsLayer"
                                 ItemsSource="{x:Bind ViewModel.Events, Mode=OneWay}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="dto:TimelineEventDto">
                                <controls:EventBubble Event="{x:Bind Mode=OneWay}"
                                                     Width="{x:Bind Width}"
                                                     Height="{x:Bind Height}"
                                                     Tapped="EventBubble_Tapped"
                                                     RightTapped="EventBubble_RightTapped"
                                                     PointerEntered="EventBubble_PointerEntered"
                                                     PointerExited="EventBubble_PointerExited">
                                    <controls:EventBubble.RenderTransform>
                                        <TranslateTransform X="{x:Bind PixelX}" Y="{x:Bind PixelY}"/>
                                    </controls:EventBubble.RenderTransform>
                                    <controls:EventBubble.ContextFlyout>
                                        <MenuFlyout>
                                            <MenuFlyoutItem Text="View Details"
                                                           Click="ViewEventMenuItem_Click">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xE8A7;"/>
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>
                                            <MenuFlyoutItem Text="Edit Event"
                                                           Click="EditEventMenuItem_Click">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xE70F;"/>
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>
                                            <MenuFlyoutSeparator/>
                                            <MenuFlyoutItem Text="Delete Event"
                                                           Click="DeleteEventMenuItem_Click">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xE74D;"/>
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>
                                        </MenuFlyout>
                                    </controls:EventBubble.ContextFlyout>
                                </controls:EventBubble>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Canvas>

                <!-- Era bars layer - thin horizontal colored lines showing time spans -->
                <ItemsControl x:Name="EraBarsLayer"
                             Grid.Row="1"
                             ItemsSource="{x:Bind ViewModel.VisibleEraBars, Mode=OneWay}"
                             Height="{x:Bind ViewModel.EraBarsHeight, Mode=OneWay}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="dto:EraBarDto">
                            <Rectangle Fill="{x:Bind ColorBrush, Mode=OneWay}"
                                      Width="{x:Bind Width}"
                                      Height="4"
                                      RadiusX="2"
                                      RadiusY="2"
                                      Opacity="0.9">
                                <Rectangle.RenderTransform>
                                    <TranslateTransform X="{x:Bind PixelX}" Y="{x:Bind TrackY}"/>
                                </Rectangle.RenderTransform>
                            </Rectangle>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Timeline axis and ticks (bottom area) -->
                <Grid Grid.Row="2">
                    <!-- Timeline axis line -->
                    <Canvas x:Name="AxisCanvas">
                        <Line x:Name="TimelineAxis"
                              X1="0" Y1="0"
                              X2="10000" Y2="0"
                              Stroke="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                              StrokeThickness="2"/>
                    </Canvas>

                    <!-- Time ruler ticks layer - Adobe Premiere style adaptive density -->
                    <ItemsControl x:Name="TimeRulerLayer"
                                 ItemsSource="{x:Bind ViewModel.TimeRulerTicks, Mode=OneWay}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="dto:TimeRulerTickDto">
                                <StackPanel Orientation="Vertical">
                                    <!-- Tick mark -->
                                    <Rectangle Width="1"
                                              Height="{x:Bind TickHeight}"
                                              Fill="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                                    <!-- Label (only visible for major ticks) -->
                                    <TextBlock Text="{x:Bind Label}"
                                              FontSize="10"
                                              Opacity="{x:Bind LabelOpacity}"
                                              Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                                              Margin="-20,2,0,0"/>
                                    <StackPanel.RenderTransform>
                                        <TranslateTransform X="{x:Bind PixelX}" Y="0"/>
                                    </StackPanel.RenderTransform>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Grid>
            </Grid>

            <!-- Zoom controls overlay -->
            <StackPanel Orientation="Horizontal"
                       HorizontalAlignment="Right"
                       VerticalAlignment="Top"
                       Margin="0,12,20,0"
                       Spacing="8"
                       Canvas.ZIndex="100">

                <!-- Quick date navigation -->
                <TextBox x:Name="QuickDateBox"
                        PlaceholderText="mmddyy or yyyy"
                        Width="110"
                        VerticalAlignment="Center"
                        KeyDown="QuickDateBox_KeyDown"/>

                <Button Content="&#xE71E;"
                       FontFamily="Segoe MDL2 Assets"
                       FontSize="16"
                       Command="{x:Bind ViewModel.ZoomOutCommand}"
                       IsEnabled="{x:Bind ViewModel.CanZoomOut, Mode=OneWay}"
                       Style="{StaticResource AccentButtonStyle}"
                       Width="40" Height="40"/>

                <ComboBox x:Name="ZoomLevelCombo"
                         SelectedIndex="1"
                         Width="120"
                         SelectionChanged="ZoomLevelCombo_SelectionChanged">
                    <ComboBoxItem Content="Year View" Tag="Year"/>
                    <ComboBoxItem Content="Month View" Tag="Month"/>
                    <ComboBoxItem Content="Week View" Tag="Week"/>
                    <ComboBoxItem Content="Day View" Tag="Day"/>
                </ComboBox>

                <Button Content="&#xE71D;"
                       FontFamily="Segoe MDL2 Assets"
                       FontSize="16"
                       Command="{x:Bind ViewModel.ZoomInCommand}"
                       IsEnabled="{x:Bind ViewModel.CanZoomIn, Mode=OneWay}"
                       Style="{StaticResource AccentButtonStyle}"
                       Width="40" Height="40"/>
            </StackPanel>

            <!-- Event details panel (slides in from right) -->
            <Grid x:Name="EventDetailsPanel"
                  HorizontalAlignment="Right"
                  Width="320"
                  Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}"
                  Visibility="{x:Bind ViewModel.SelectedEvent, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}"
                  Canvas.ZIndex="200">

                <ScrollViewer>
                    <StackPanel Padding="20" Spacing="12">
                        <Grid>
                            <TextBlock Text="Event Details"
                                      FontSize="20"
                                      FontWeight="SemiBold"/>
                            <Button Content="&#xE711;"
                                   FontFamily="Segoe MDL2 Assets"
                                   HorizontalAlignment="Right"
                                   Background="Transparent"
                                   Command="{x:Bind ViewModel.SelectEventCommand}"/>
                        </Grid>

                        <TextBlock Text="{x:Bind ViewModel.SelectedEvent.Title, Mode=OneWay, FallbackValue=''}"
                                  FontSize="16"
                                  FontWeight="SemiBold"
                                  TextWrapping="Wrap"/>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE787;" FontSize="14"/>
                            <TextBlock Text="{x:Bind ViewModel.SelectedEvent.StartDate, Mode=OneWay, FallbackValue=''}"
                                      FontSize="14"
                                      Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                        </StackPanel>

                        <TextBlock Text="{x:Bind ViewModel.SelectedEvent.Description, Mode=OneWay, FallbackValue=''}"
                                  TextWrapping="Wrap"
                                  FontSize="14"/>

                        <!-- Action buttons -->
                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,12,0,0">
                            <Button Content="Edit"
                                   Click="EditSelectedEvent_Click"
                                   Style="{StaticResource AccentButtonStyle}"
                                   Width="80">
                                <Button.KeyboardAccelerators>
                                    <KeyboardAccelerator Key="E" Modifiers="Control"/>
                                </Button.KeyboardAccelerators>
                            </Button>
                            <Button Content="Delete"
                                   Click="DeleteSelectedEvent_Click"
                                   Width="80">
                                <Button.KeyboardAccelerators>
                                    <KeyboardAccelerator Key="Delete"/>
                                </Button.KeyboardAccelerators>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>

        <!-- Proportional scrollbar (Premiere-style) -->
        <controls:ProportionalScrollBar x:Name="TimelineScrollBar"
                                        Grid.Row="2"
                                        Height="20"
                                        Margin="8,4"
                                        ScrollOffsetChanged="TimelineScrollBar_ScrollOffsetChanged"
                                        ViewDurationChanged="TimelineScrollBar_ViewDurationChanged"/>

        <!-- Navigation controls -->
        <CommandBar Grid.Row="3"
                   DefaultLabelPosition="Right"
                   Canvas.ZIndex="100">

            <AppBarButton Label="Add Event"
                         Click="AddEventButton_Click">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE710;"/>
                </AppBarButton.Icon>
            </AppBarButton>

            <AppBarSeparator/>

            <AppBarButton Label="Go to Today"
                         Command="{x:Bind ViewModel.GoToTodayCommand}">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE8D1;"/>
                </AppBarButton.Icon>
            </AppBarButton>

            <AppBarButton Label="Refresh"
                         Command="{x:Bind ViewModel.RefreshCommand}">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE72C;"/>
                </AppBarButton.Icon>
            </AppBarButton>

            <AppBarSeparator/>

            <CommandBar.Content>
                <StackPanel Orientation="Horizontal" Spacing="12" Margin="12,0,0,0">
                    <TextBlock Text="{x:Bind ViewModel.StatusText, Mode=OneWay}"
                              VerticalAlignment="Center"
                              FontSize="14"/>
                    <TextBlock x:Name="HoverDateText"
                              VerticalAlignment="Center"
                              FontSize="12"
                              Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                              Visibility="Collapsed"/>
                </StackPanel>
            </CommandBar.Content>
        </CommandBar>

        <!-- Add/Edit Event Dialog -->
        <ContentDialog x:Name="EventDialog"
                      Title="Add Event"
                      PrimaryButtonText="Save"
                      CloseButtonText="Cancel"
                      DefaultButton="Primary"
                      PrimaryButtonClick="EventDialog_PrimaryButtonClick">
            <StackPanel Spacing="16" MinWidth="400">
                <TextBox x:Name="EventTitleBox"
                        Header="Title"
                        PlaceholderText="Enter event title"/>

                <StackPanel Spacing="8">
                    <TextBlock Text="Date" FontWeight="SemiBold"/>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBox x:Name="EventDateTextBox"
                                PlaceholderText="mmddyy"
                                Width="100"
                                TextChanged="EventDateTextBox_TextChanged"/>
                        <TextBlock Text="or" VerticalAlignment="Center"
                                  Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                        <CalendarDatePicker x:Name="EventDatePicker"
                                           PlaceholderText="Select date"
                                           DateFormat="{}{month.full} {day.integer}, {year.full}"
                                           DateChanged="EventDatePicker_DateChanged"/>
                    </StackPanel>
                </StackPanel>

                <TextBox x:Name="EventDescriptionBox"
                        Header="Description"
                        PlaceholderText="Enter description (optional)"
                        AcceptsReturn="True"
                        TextWrapping="Wrap"
                        Height="100"/>

                <ComboBox x:Name="EventCategoryCombo"
                         Header="Category"
                         PlaceholderText="Select category"
                         HorizontalAlignment="Stretch">
                    <ComboBoxItem Content="Milestone" Tag="milestone"/>
                    <ComboBoxItem Content="Work" Tag="work"/>
                    <ComboBoxItem Content="Education" Tag="education"/>
                    <ComboBoxItem Content="Relationship" Tag="relationship"/>
                    <ComboBoxItem Content="Travel" Tag="travel"/>
                    <ComboBoxItem Content="Achievement" Tag="achievement"/>
                    <ComboBoxItem Content="Challenge" Tag="challenge"/>
                    <ComboBoxItem Content="Era" Tag="era"/>
                    <ComboBoxItem Content="Other" Tag="other"/>
                </ComboBox>

                <TextBox x:Name="EventLocationBox"
                        Header="Location (optional)"
                        PlaceholderText="Enter location"/>
            </StackPanel>
        </ContentDialog>

        <!-- Delete confirmation dialog -->
        <ContentDialog x:Name="DeleteConfirmDialog"
                      Title="Delete Event"
                      Content="Are you sure you want to delete this event? This action cannot be undone."
                      PrimaryButtonText="Delete"
                      CloseButtonText="Cancel"
                      DefaultButton="Close"/>

        <!-- Go to Date dialog -->
        <ContentDialog x:Name="GoToDateDialog"
                      Title="Go to Date"
                      PrimaryButtonText="Go"
                      CloseButtonText="Cancel"
                      DefaultButton="Primary"
                      PrimaryButtonClick="GoToDateDialog_PrimaryButtonClick">
            <StackPanel Spacing="16" MinWidth="300">
                <TextBox x:Name="GoToDateTextBox"
                        Header="Enter date (mmddyy) or year (yyyy)"
                        PlaceholderText="e.g., 010190 or 1990"
                        KeyDown="GoToDateTextBox_KeyDown"/>
                <TextBlock x:Name="GoToDateHint"
                          Text="Tip: Enter just a year (e.g., 2006) to show that year centered with surrounding years"
                          FontSize="12"
                          Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                          TextWrapping="Wrap"/>
            </StackPanel>
        </ContentDialog>
    </Grid>
</UserControl>
