<UserControl
    x:Class="MemoryTimeline.Controls.TimelineControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:MemoryTimeline.Controls"
    xmlns:dto="using:MemoryTimeline.Core.DTOs"
    mc:Ignorable="d"
    d:DesignHeight="600"
    d:DesignWidth="1000">

    <Grid x:Name="RootGrid" Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <!-- Loading overlay -->
        <Grid x:Name="LoadingOverlay"
              Visibility="Collapsed"
              Background="#80000000"
              Canvas.ZIndex="1000">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="12">
                <ProgressRing IsActive="True" Width="48" Height="48"/>
                <TextBlock Text="Loading timeline..."
                          FontSize="16"
                          Foreground="White"
                          HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>

        <!-- Main timeline container -->
        <ScrollViewer x:Name="TimelineScrollViewer"
                     HorizontalScrollBarVisibility="Auto"
                     VerticalScrollBarVisibility="Auto"
                     HorizontalScrollMode="Enabled"
                     VerticalScrollMode="Enabled"
                     ZoomMode="Disabled"
                     ManipulationMode="TranslateX,TranslateY,Scale,TranslateInertia"
                     ViewChanged="TimelineScrollViewer_ViewChanged">

            <Grid x:Name="TimelineCanvas"
                  Width="10000"
                  Height="1000"
                  Background="Transparent"
                  ManipulationMode="TranslateX,TranslateY,Scale,TranslateInertia"
                  ManipulationDelta="TimelineCanvas_ManipulationDelta"
                  ManipulationCompleted="TimelineCanvas_ManipulationCompleted"
                  DoubleTapped="TimelineCanvas_DoubleTapped">

                <!-- Era background layer -->
                <ItemsControl x:Name="ErasLayer"
                             ItemsSource="{x:Bind ViewModel.Eras, Mode=OneWay}"
                             Canvas.ZIndex="0">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="dto:TimelineEraDto">
                            <Rectangle Fill="{x:Bind ColorCode}"
                                      Opacity="0.1"
                                      Canvas.Left="{x:Bind PixelX}"
                                      Canvas.Top="0"
                                      Width="{x:Bind Width}"
                                      Height="1000"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Timeline axis -->
                <Canvas x:Name="AxisCanvas" Canvas.ZIndex="5">
                    <Line x:Name="TimelineAxis"
                          X1="0" Y1="50"
                          X2="10000" Y2="50"
                          Stroke="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                          StrokeThickness="2"/>

                    <!-- Date markers will be added dynamically in code-behind -->
                </Canvas>

                <!-- Events layer -->
                <ItemsControl x:Name="EventsLayer"
                             ItemsSource="{x:Bind ViewModel.Events, Mode=OneWay}"
                             Canvas.ZIndex="10">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="dto:TimelineEventDto">
                            <controls:EventBubble Event="{x:Bind Mode=OneWay}"
                                                 Canvas.Left="{x:Bind PixelX}"
                                                 Canvas.Top="{x:Bind PixelY}"
                                                 Width="{x:Bind Width}"
                                                 Height="{x:Bind Height}"
                                                 Tapped="EventBubble_Tapped"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </ScrollViewer>

        <!-- Zoom controls overlay -->
        <StackPanel Orientation="Horizontal"
                   HorizontalAlignment="Right"
                   VerticalAlignment="Bottom"
                   Margin="0,0,20,80"
                   Spacing="8"
                   Canvas.ZIndex="100">

            <Button Content="&#xE71E;"
                   FontFamily="Segoe MDL2 Assets"
                   FontSize="16"
                   ToolTipService.ToolTip="Zoom Out"
                   Command="{x:Bind ViewModel.ZoomOutCommand}"
                   IsEnabled="{x:Bind ViewModel.CanZoomOut, Mode=OneWay}"
                   Style="{StaticResource AccentButtonStyle}"
                   Width="40" Height="40"/>

            <ComboBox x:Name="ZoomLevelCombo"
                     SelectedIndex="1"
                     Width="120"
                     SelectionChanged="ZoomLevelCombo_SelectionChanged">
                <ComboBoxItem Content="Year View" Tag="Year"/>
                <ComboBoxItem Content="Month View" Tag="Month"/>
                <ComboBoxItem Content="Week View" Tag="Week"/>
                <ComboBoxItem Content="Day View" Tag="Day"/>
            </ComboBox>

            <Button Content="&#xE71D;"
                   FontFamily="Segoe MDL2 Assets"
                   FontSize="16"
                   ToolTipService.ToolTip="Zoom In"
                   Command="{x:Bind ViewModel.ZoomInCommand}"
                   IsEnabled="{x:Bind ViewModel.CanZoomIn, Mode=OneWay}"
                   Style="{StaticResource AccentButtonStyle}"
                   Width="40" Height="40"/>
        </StackPanel>

        <!-- Navigation controls -->
        <CommandBar VerticalAlignment="Bottom"
                   DefaultLabelPosition="Right"
                   Canvas.ZIndex="100">

            <AppBarButton Icon="GlobalNavigationButton"
                         Label="Go to Today"
                         Command="{x:Bind ViewModel.GoToTodayCommand}"/>

            <AppBarButton Icon="Refresh"
                         Label="Refresh"
                         Command="{x:Bind ViewModel.RefreshCommand}"/>

            <CommandBar.Content>
                <TextBlock Text="{x:Bind ViewModel.StatusText, Mode=OneWay}"
                          VerticalAlignment="Center"
                          Margin="12,0,0,0"
                          FontSize="14"/>
            </CommandBar.Content>
        </CommandBar>

        <!-- Event details panel (slides in from right) -->
        <Grid x:Name="EventDetailsPanel"
              HorizontalAlignment="Right"
              Width="320"
              Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}"
              Visibility="{x:Bind ViewModel.SelectedEvent, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}"
              Canvas.ZIndex="200">

            <ScrollViewer>
                <StackPanel Padding="20" Spacing="12">
                    <TextBlock Text="Event Details"
                              FontSize="20"
                              FontWeight="SemiBold"/>

                    <TextBlock Text="{x:Bind ViewModel.SelectedEvent.Title, Mode=OneWay}"
                              FontSize="16"
                              TextWrapping="Wrap"/>

                    <TextBlock Text="{x:Bind ViewModel.SelectedEvent.StartDate, Mode=OneWay}"
                              FontSize="14"
                              Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>

                    <TextBlock Text="{x:Bind ViewModel.SelectedEvent.Description, Mode=OneWay}"
                              TextWrapping="Wrap"
                              FontSize="14"/>

                    <Button Content="Close"
                           Command="{x:Bind ViewModel.SelectEventCommand}"
                           CommandParameter="{x:Null}"
                           HorizontalAlignment="Stretch"/>
                </StackPanel>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>
