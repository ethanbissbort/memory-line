<UserControl
    x:Class="MemoryTimeline.Controls.TimelineControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:MemoryTimeline.Controls"
    xmlns:dto="using:MemoryTimeline.Core.DTOs"
    mc:Ignorable="d"
    d:DesignHeight="600"
    d:DesignWidth="1000">

    <Grid x:Name="RootGrid" Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <!-- Loading overlay -->
        <Grid x:Name="LoadingOverlay"
              Visibility="Collapsed"
              Background="#80000000"
              Canvas.ZIndex="1000">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="12">
                <ProgressRing IsActive="True" Width="48" Height="48"/>
                <TextBlock Text="Loading timeline..."
                          FontSize="16"
                          Foreground="White"
                          HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>

        <!-- Main timeline container -->
        <ScrollViewer x:Name="TimelineScrollViewer"
                     HorizontalScrollBarVisibility="Auto"
                     VerticalScrollBarVisibility="Auto"
                     HorizontalScrollMode="Enabled"
                     VerticalScrollMode="Enabled"
                     ZoomMode="Disabled"
                     ManipulationMode="TranslateX,TranslateY,Scale,TranslateInertia"
                     ViewChanged="TimelineScrollViewer_ViewChanged">

            <Grid x:Name="TimelineCanvas"
                  Width="10000"
                  Height="1000"
                  Background="Transparent"
                  ManipulationMode="TranslateX,TranslateY,Scale,TranslateInertia"
                  ManipulationDelta="TimelineCanvas_ManipulationDelta"
                  ManipulationCompleted="TimelineCanvas_ManipulationCompleted"
                  DoubleTapped="TimelineCanvas_DoubleTapped"
                  RightTapped="TimelineCanvas_RightTapped"
                  PointerMoved="TimelineCanvas_PointerMoved">

                <!-- Context menu for timeline canvas (add event) -->
                <Grid.ContextFlyout>
                    <MenuFlyout x:Name="TimelineContextMenu">
                        <MenuFlyoutItem x:Name="AddEventMenuItem"
                                       Text="Add Event Here"
                                       Click="AddEventMenuItem_Click">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE710;"/>
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutSeparator/>
                        <MenuFlyoutItem Text="Go to Today"
                                       Command="{x:Bind ViewModel.GoToTodayCommand}">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE8D1;"/>
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutItem Text="Refresh"
                                       Command="{x:Bind ViewModel.RefreshCommand}">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE72C;"/>
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                    </MenuFlyout>
                </Grid.ContextFlyout>

                <!-- Era background layer -->
                <ItemsControl x:Name="ErasLayer"
                             ItemsSource="{x:Bind ViewModel.Eras, Mode=OneWay}"
                             Canvas.ZIndex="0">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="dto:TimelineEraDto">
                            <Rectangle Fill="{x:Bind ColorBrush, Mode=OneWay}"
                                      Opacity="0.1"
                                      Canvas.Left="{x:Bind PixelX}"
                                      Canvas.Top="0"
                                      Width="{x:Bind Width}"
                                      Height="1000"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Timeline axis -->
                <Canvas x:Name="AxisCanvas" Canvas.ZIndex="5">
                    <Line x:Name="TimelineAxis"
                          X1="0" Y1="50"
                          X2="10000" Y2="50"
                          Stroke="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                          StrokeThickness="2"/>
                </Canvas>

                <!-- Events layer -->
                <ItemsControl x:Name="EventsLayer"
                             ItemsSource="{x:Bind ViewModel.Events, Mode=OneWay}"
                             Canvas.ZIndex="10">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="dto:TimelineEventDto">
                            <controls:EventBubble Event="{x:Bind Mode=OneWay}"
                                                 Canvas.Left="{x:Bind PixelX}"
                                                 Canvas.Top="{x:Bind PixelY}"
                                                 Width="{x:Bind Width}"
                                                 Height="{x:Bind Height}"
                                                 Tapped="EventBubble_Tapped"
                                                 RightTapped="EventBubble_RightTapped"
                                                 PointerEntered="EventBubble_PointerEntered"
                                                 PointerExited="EventBubble_PointerExited">
                                <controls:EventBubble.ContextFlyout>
                                    <MenuFlyout>
                                        <MenuFlyoutItem Text="View Details"
                                                       Click="ViewEventMenuItem_Click">
                                            <MenuFlyoutItem.Icon>
                                                <FontIcon Glyph="&#xE8A7;"/>
                                            </MenuFlyoutItem.Icon>
                                        </MenuFlyoutItem>
                                        <MenuFlyoutItem Text="Edit Event"
                                                       Click="EditEventMenuItem_Click">
                                            <MenuFlyoutItem.Icon>
                                                <FontIcon Glyph="&#xE70F;"/>
                                            </MenuFlyoutItem.Icon>
                                        </MenuFlyoutItem>
                                        <MenuFlyoutSeparator/>
                                        <MenuFlyoutItem Text="Delete Event"
                                                       Click="DeleteEventMenuItem_Click">
                                            <MenuFlyoutItem.Icon>
                                                <FontIcon Glyph="&#xE74D;"/>
                                            </MenuFlyoutItem.Icon>
                                        </MenuFlyoutItem>
                                    </MenuFlyout>
                                </controls:EventBubble.ContextFlyout>
                            </controls:EventBubble>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </ScrollViewer>

        <!-- Zoom controls overlay -->
        <StackPanel Orientation="Horizontal"
                   HorizontalAlignment="Right"
                   VerticalAlignment="Bottom"
                   Margin="0,0,20,80"
                   Spacing="8"
                   Canvas.ZIndex="100">

            <Button Content="&#xE71E;"
                   FontFamily="Segoe MDL2 Assets"
                   FontSize="16"
                   ToolTipService.ToolTip="Zoom Out"
                   Command="{x:Bind ViewModel.ZoomOutCommand}"
                   IsEnabled="{x:Bind ViewModel.CanZoomOut, Mode=OneWay}"
                   Style="{StaticResource AccentButtonStyle}"
                   Width="40" Height="40"/>

            <ComboBox x:Name="ZoomLevelCombo"
                     SelectedIndex="1"
                     Width="120"
                     SelectionChanged="ZoomLevelCombo_SelectionChanged">
                <ComboBoxItem Content="Year View" Tag="Year"/>
                <ComboBoxItem Content="Month View" Tag="Month"/>
                <ComboBoxItem Content="Week View" Tag="Week"/>
                <ComboBoxItem Content="Day View" Tag="Day"/>
            </ComboBox>

            <Button Content="&#xE71D;"
                   FontFamily="Segoe MDL2 Assets"
                   FontSize="16"
                   ToolTipService.ToolTip="Zoom In"
                   Command="{x:Bind ViewModel.ZoomInCommand}"
                   IsEnabled="{x:Bind ViewModel.CanZoomIn, Mode=OneWay}"
                   Style="{StaticResource AccentButtonStyle}"
                   Width="40" Height="40"/>
        </StackPanel>

        <!-- Navigation controls -->
        <CommandBar VerticalAlignment="Bottom"
                   DefaultLabelPosition="Right"
                   Canvas.ZIndex="100">

            <AppBarButton Label="Add Event"
                         Click="AddEventButton_Click"
                         ToolTipService.ToolTip="Create a new event (Ctrl+N)">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE710;"/>
                </AppBarButton.Icon>
                <AppBarButton.KeyboardAccelerators>
                    <KeyboardAccelerator Key="N" Modifiers="Control"/>
                </AppBarButton.KeyboardAccelerators>
            </AppBarButton>

            <AppBarSeparator/>

            <AppBarButton Label="Go to Today"
                         Command="{x:Bind ViewModel.GoToTodayCommand}">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE8D1;"/>
                </AppBarButton.Icon>
            </AppBarButton>

            <AppBarButton Label="Refresh"
                         Command="{x:Bind ViewModel.RefreshCommand}">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE72C;"/>
                </AppBarButton.Icon>
            </AppBarButton>

            <AppBarSeparator/>

            <CommandBar.Content>
                <StackPanel Orientation="Horizontal" Spacing="12" Margin="12,0,0,0">
                    <TextBlock Text="{x:Bind ViewModel.StatusText, Mode=OneWay}"
                              VerticalAlignment="Center"
                              FontSize="14"/>
                    <TextBlock x:Name="HoverDateText"
                              VerticalAlignment="Center"
                              FontSize="12"
                              Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                              Visibility="Collapsed"/>
                </StackPanel>
            </CommandBar.Content>
        </CommandBar>

        <!-- Event details panel (slides in from right) -->
        <Grid x:Name="EventDetailsPanel"
              HorizontalAlignment="Right"
              Width="320"
              Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}"
              Visibility="{x:Bind ViewModel.SelectedEvent, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}"
              Canvas.ZIndex="200">

            <ScrollViewer>
                <StackPanel Padding="20" Spacing="12">
                    <Grid>
                        <TextBlock Text="Event Details"
                                  FontSize="20"
                                  FontWeight="SemiBold"/>
                        <Button Content="&#xE711;"
                               FontFamily="Segoe MDL2 Assets"
                               HorizontalAlignment="Right"
                               Background="Transparent"
                               ToolTipService.ToolTip="Close"
                               Command="{x:Bind ViewModel.SelectEventCommand}"/>
                    </Grid>

                    <TextBlock Text="{x:Bind ViewModel.SelectedEvent.Title, Mode=OneWay, FallbackValue=''}"
                              FontSize="16"
                              FontWeight="SemiBold"
                              TextWrapping="Wrap"/>

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE787;" FontSize="14"/>
                        <TextBlock Text="{x:Bind ViewModel.SelectedEvent.StartDate, Mode=OneWay, FallbackValue=''}"
                                  FontSize="14"
                                  Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                    </StackPanel>

                    <TextBlock Text="{x:Bind ViewModel.SelectedEvent.Description, Mode=OneWay, FallbackValue=''}"
                              TextWrapping="Wrap"
                              FontSize="14"/>

                    <!-- Action buttons -->
                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,12,0,0">
                        <Button Content="Edit"
                               Click="EditSelectedEvent_Click"
                               Style="{StaticResource AccentButtonStyle}"
                               Width="80">
                            <Button.KeyboardAccelerators>
                                <KeyboardAccelerator Key="E" Modifiers="Control"/>
                            </Button.KeyboardAccelerators>
                        </Button>
                        <Button Content="Delete"
                               Click="DeleteSelectedEvent_Click"
                               Width="80">
                            <Button.KeyboardAccelerators>
                                <KeyboardAccelerator Key="Delete"/>
                            </Button.KeyboardAccelerators>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
        </Grid>

        <!-- Add/Edit Event Dialog -->
        <ContentDialog x:Name="EventDialog"
                      Title="Add Event"
                      PrimaryButtonText="Save"
                      CloseButtonText="Cancel"
                      DefaultButton="Primary"
                      PrimaryButtonClick="EventDialog_PrimaryButtonClick">
            <StackPanel Spacing="16" MinWidth="400">
                <TextBox x:Name="EventTitleBox"
                        Header="Title"
                        PlaceholderText="Enter event title"/>

                <CalendarDatePicker x:Name="EventDatePicker"
                                   Header="Date"
                                   PlaceholderText="Select date"
                                   DateFormat="{}{month.full} {day.integer}, {year.full}"/>

                <TextBox x:Name="EventDescriptionBox"
                        Header="Description"
                        PlaceholderText="Enter description (optional)"
                        AcceptsReturn="True"
                        TextWrapping="Wrap"
                        Height="100"/>

                <ComboBox x:Name="EventCategoryCombo"
                         Header="Category"
                         PlaceholderText="Select category"
                         HorizontalAlignment="Stretch">
                    <ComboBoxItem Content="Milestone" Tag="milestone"/>
                    <ComboBoxItem Content="Work" Tag="work"/>
                    <ComboBoxItem Content="Education" Tag="education"/>
                    <ComboBoxItem Content="Relationship" Tag="relationship"/>
                    <ComboBoxItem Content="Travel" Tag="travel"/>
                    <ComboBoxItem Content="Achievement" Tag="achievement"/>
                    <ComboBoxItem Content="Challenge" Tag="challenge"/>
                    <ComboBoxItem Content="Era" Tag="era"/>
                    <ComboBoxItem Content="Other" Tag="other"/>
                </ComboBox>

                <TextBox x:Name="EventLocationBox"
                        Header="Location (optional)"
                        PlaceholderText="Enter location"/>
            </StackPanel>
        </ContentDialog>

        <!-- Delete confirmation dialog -->
        <ContentDialog x:Name="DeleteConfirmDialog"
                      Title="Delete Event"
                      Content="Are you sure you want to delete this event? This action cannot be undone."
                      PrimaryButtonText="Delete"
                      CloseButtonText="Cancel"
                      DefaultButton="Close"/>
    </Grid>
</UserControl>
